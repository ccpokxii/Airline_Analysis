---
title: "STAT 480 Group Project"
subtitle: "Airline Data Analysis: 1998 & 2002"
author: "Yutong Wang, Yihang Zhang, Brandon Nsiah-Ababio, Siddharth Ahuja"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Goal of Project

The general goal of the project is to extract interesting information, trends and comparisons about flights in the United States during the years of 1998 and 2002.

To achieve this goal we will explore the following areas:

* Trends in cancellations of flights
* Trends in delayed arrival or departure of flights
* Trends in number of flights
* Trends in diversions of flights
* Trends of flights by region

# Data Description



\newpage

# Setup for Project

## Downloading the necessary data (done in terminal):

```{}
wget https://raw.githubusercontent.com/coatless/stat490uiuc/master/airlines/airlines_data.sh
chmod u+x airlines_data.sh
./airlines_data.sh 2002 2002
mv airlines.csv groupproject.csv
./airlines_data.sh 1998 1998
tail -n+2 airlines.csv >> groupproject.csv
```

&nbsp;

## Deleting columns with all or most data missing (done in terminal):

```{}
cut -d ',' -f 23,25,26,27,28,29 --complement groupproject.csv > groupprojectcl.csv
```

&nbsp;

## Creating the necessary tables (done in hive):

Creating table with flight data:

```{}
CREATE TABLE flights (Year INT, Month INT, DayofMonth INT,  DayOfWeek INT, DepTime INT, 
CRSDepTime INT, ArrTime INT, CRSArrTime INT, UniqueCarrier STRING, FlightNum INT, TailNum STRING, 
ActualElapsedTime INT, CRSElapsedTime INT, AirTime INT, ArrDelay INT, DepDelay INT, Origin STRING, 
Dest STRING, Distance INT, TaxiIn INT, TaxiOut INT,Cancelled INT, Diverted INT)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ',';

LOAD DATA LOCAL INPATH 'groupprojectcl.csv'
OVERWRITE INTO TABLE flights;

ALTER TABLE flights set tblproperties("skip.header.line.count"="1");
```

&nbsp; 

Creating table with airport data:

&nbsp;

```{}
CREATE TABLE airports (iata STRING, airport STRING, city STRING, state STRING, 
country STRING, lat DOUBLE, long DOUBLE)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ',';

LOAD DATA LOCAL INPATH 'airports.csv'
OVERWRITE INTO TABLE airports;

ALTER TABLE airports set tblproperties("skip.header.line.count"="1");
```

&nbsp;

## Loading data into a big matrix (done in R):

```{r}
#install.packages('biganalytics')
#install.packages('foreach')
library(biganalytics)
library(foreach)

## Function to apply to a CSV file to convert a list of columns to integer index values.
## 
#convertCSVColumns <- function(file, collist){
#  fulldata<-read.csv(file)
#   for (i in collist) {
#     fulldata[,i]<-convertColumn(fulldata[,i])
#   }
#   write.csv(fulldata, file, row.names=FALSE)
# }
# # The following function is called by convertCSVColumns. It converts a single
# #column to integer indices.
# convertColumn <- function(values){
#   allvals<-as.character(values)
#   valslist<-sort(unique(allvals))
#   xx<-factor(allvals, valslist, labels=1:length(valslist))
#   rm(allvals)
#   rm(valslist)
#   gc()
#   as.numeric(levels(xx))[xx]
# }
# 
# # Now use the function on the data.
# convertCSVColumns("groupprojectcl.csv", c(9,11,17,18))
# 
# x <- read.big.matrix("groupprojectcl.csv", header = TRUE,
#                      backingfile = "gp.bin",
#                      descriptorfile = "gp.desc",
#                      type = "integer")

x <- attach.big.matrix('gp.desc')
```


\newpage

# Initial Observations

Missing airlines 'American Eagle'

\newpage

# Cancellation Trends

```{r}
year = split(1:nrow(x), x[, 'Year'])
cancelA = foreach(i = year, .combine = cbind) %do% {
  CancelledCount = sum(x[i, 'Cancelled'])
  Total = length(x[i, 'Cancelled'])
  list(CancelledCount = CancelledCount, Total = Total)
}
colnames(cancelA) = c('1998', '2002')
cancelA
```

```{r}
cancelB = foreach(i = year, .combine = cbind) %do% {
  CancelledPercent = (sum(x[i, 'Cancelled'])/(length(x[i, 'Cancelled'])))*100
  list(CancelledPercent = CancelledPercent)
}
colnames(cancelB) = c('1998', '2002')
cancelB

# Plot with Cancelled Count and Percent on same bar graph, two y-axis?
```

by Month

1998
```{r}
month1998 = split(1:sum(x[, 'Year'] == 1998), x[x[, 'Year'] == 1998, 'Month'])

month1998A = foreach(i = month1998, .combine=cbind) %do% {
  a = sum(x[i,'Cancelled'])
  b = length(x[i, 'Cancelled'])
  c = (a/b)*100
  list(CancelledCount1998 = a, Total1998 = b, CancelledPercent1998 = c)
}
colnames(month1998A) = c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')
month1998A
```

2002
```{r}
month2002 = split(1:sum(x[, 'Year'] == 2002), x[x[, 'Year'] == 2002, 'Month'])

month2002A = foreach(i = month2002, .combine=cbind) %do% {
  a = sum(x[i,'Cancelled'])
  b = length(x[i, 'Cancelled'])
  c = (a/b)*100
  list(CancelledCount2002 = a, Total2002 = b, CancelledPercent2002 = c)
}
colnames(month2002A) = c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')
month2002A
```

by Day

1998
```{r}
day1998 = split(1:sum(x[, 'Year'] == 1998), x[x[, 'Year'] == 1998, 'DayOfWeek'])

day1998A = foreach(i = day1998, .combine=cbind) %do% {
  a = sum(x[i,'Cancelled'])
  b = length(x[i, 'Cancelled'])
  c = (a/b)*100
  list(CancelledCount1998 = a, Total1998 = b, CancelledPercent1998 = c)
}
colnames(day1998A) = c('Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat')
day1998A
```
```{r}
day2002 = split(1:sum(x[, 'Year'] == 2002), x[x[, 'Year'] == 2002, 'DayOfWeek'])

day2002A = foreach(i = day2002, .combine=cbind) %do% {
  a = sum(x[i,'Cancelled'])
  b = length(x[i, 'Cancelled'])
  c = (a/b)*100
  list(CancelledCount2002 = a, Total2002 = b, CancelledPercent2002 = c)
}
colnames(day2002A) = c('Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat')
day2002A
```


Plot Month
```{r}
#install.packages('ggplot2')

library(ggplot2)
CancelledCountA = unlist(c(month1998A[1,], month2002A[1,]))
month = rep(seq(1:12), times = 2)
yearMonth = rep(c(1998, 2002), each = 12)

dfMonthCount = as.data.frame(t(rbind(yearMonth, month, CancelledCountA)))
dfMonthCount

ggplot(dfMonthCount, aes(x = factor(month), y = CancelledCountA, fill = factor(yearMonth))) + geom_bar(stat = 'identity', position = 'dodge')
```